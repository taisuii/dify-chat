---
description: 开发前阅读项目架构，开发时避免后台运行与重复创建脚本，大改动后同步更新架构文档；发布时必做：删 dist-packages、提版本、构建、验证、更新 skill
alwaysApply: true
---

# 开发流程规则

## 开发前

- **必须先阅读项目架构**：在改代码前，查阅 `.cursor/skills/project-architecture/SKILL.md` 与 `.cursor/skills/project-architecture/reference.md`，确认：
  - 要改的功能属于哪个包/模块
  - 该模块的职责和依赖关系
  - 相关入口与关键文件位置
- 不确定归属时，按 SKILL.md 中「修改功能时如何选包」表选择目标包，再在 reference.md 中查具体文件。

## 开发时

- **不要后台运行项目**：可通过构建或编译排查错误，但避免启动开发服务器等长期运行的进程，以免多 agent 并行时端口冲突。
- **不要多次创建运行脚本**：避免重复新增 sh、powershell 等启动/运行脚本，优先复用已有脚本或 package.json 中的命令。

## 修改后

- **评估是否属于「较大变动」**：例如：
  - 新增或删除包
  - 新增/删除模块或显著调整某包内目录结构
  - 包之间依赖关系变化
  - 某模块职责发生明显变化
- **若属于较大变动，必须同步更新项目架构**：
  - 更新 `.cursor/skills/project-architecture/SKILL.md`：包职责、依赖关系、选包表
  - 更新 `.cursor/skills/project-architecture/reference.md`：受影响包下的目录与文件说明
- 小范围修 bug、改样式、单文件逻辑调整通常无需改架构文档；有疑问时以「是否影响他人找模块/文件」为准。

## 发布与更新流程（问题修复或功能变更后需发布时）

当对 `@dify-chat/*` 包做了修改且需要发布新版本时，**必须**按以下顺序执行，缺一不可：

1. **删除 dist-packages 下的旧包**：清空 `dist-packages/` 目录下所有 `.tgz` 文件，避免与新包混淆。
2. **提高版本号**：
   - `packages/api`、`packages/core`、`packages/helpers`、`packages/theme` 的 `package.json` 中 `version` 同步提升（如 0.7.2 → 0.7.3）；
   - `packages/widget` 的 `package.json` 中 `version` 单独提升（如 0.1.2 → 0.1.3）；
   - 根目录 `package.json` 的 `version` 与 api/core/helpers/theme 保持一致。
3. **构建新包**：执行 `pnpm run pack:local`，在 `dist-packages/` 下生成带新版本号的 tgz。
4. **验证构建**（建议）：执行 `pnpm run pack:verify`，确保 tgz 在 Next.js fixture 中可正常安装与构建。
5. **更新 dify-chat-widget-integration skill**：
   - **项目内**：更新 `SKILL.md`（根目录）、`docs/INTEGRATION_WIDGET.md` 中安装说明、最小依赖清单、pnpm.overrides 示例、版本号等，确保接入方文档与发布包一致；
   - **用户级**（若存在）：同步更新 `~/.cursor/skills/dify-chat-widget-integration/SKILL.md`，保持与项目 SKILL.md 一致。

**触发条件**：修复 bug、解决兼容性问题、新增功能、调整 dist 结构或 exports 等，凡影响接入方使用方式的变更，均需走完整发布流程。

## 示例

**开发前**：要改「会话列表」→ 查 SKILL.md 知会话列表在 widget 的 `conversation-list`；查 reference.md 知具体路径为 `packages/widget/src/components/conversation-list/` 等。

**大变动后**：新增了 `packages/analytics` 包 → 在 SKILL.md 增加该包说明与依赖关系，在 reference.md 增加该包目录与关键文件表。

**发布后**：修复了 widget 的 bug → 删除 `dist-packages/*.tgz` → 将 api/core/helpers/theme 版本改为 0.7.3、widget 改为 0.1.3 → 执行 `pnpm run pack:local` → （可选）`pnpm run pack:verify` → 更新 `SKILL.md`、`docs/INTEGRATION_WIDGET.md` 及用户级 dify-chat-widget-integration skill 中的 0.7.2/0.1.2 为新版本号。
